#!/bin/bash
set -e

README="README.md"
TMP_README="$(mktemp)"

# Generate project tree (ignore unwanted dirs/files)
RAW_TREE=$(tree -a -I '.git|node_modules|__pycache__|*.pyc|*.pyo|*.pyd|.mypy_cache|.pytest_cache|.DS_Store' .)

# Wrap tree output in triple backticks for GitHub
PROJECT_TREE="```text
$RAW_TREE
```"

# Replace the section between PROJECT TREE markers
awk -v tree="$PROJECT_TREE" '
/<!-- PROJECT TREE START -->/ { 
    print
    print tree   # Insert the tree here
    in_block=1
    next
}
/<!-- PROJECT TREE END -->/ {
    print
    in_block=0
    next
}
!in_block { print }
' "$README" > "$TMP_README"

mv "$TMP_README" "$README"

# Stage updated README.md so commit includes it
git add "$README"
